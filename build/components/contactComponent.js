"use strict";!function(){function e(e,t,n,o){var i=this;i.remove=function(o,i){var r="Are you sure?",c="You are about to remove the contact",a="Go ahead";t.openConfirmDialog(o,r,c,a).then(function(o){o&&e.del("Contact",i).then(function(e){return Promise.resolve(!0)},function(e){return Promise.reject(!1)}).then(function(){var e="Contact removed",o="Done";t.showMessage(o,e).then(function(){}).then(function(){n.reload()})})})},loadCategories=function(){i.data.categories=[],e.getSchema("ContactCategory").then(function(t){var n=t.contact_id.eq(i.data.id);e.executeQuery(t,n).then(function(t){t.forEach(function(t){e.getById("Category",t.category_id).then(function(e){i.data.categories.push(e[0])})})},function(e){return console.error(e)}).then(function(){setTimeout(function(){o.$apply()},100)})})};var r=function(t){return e.getSchema("Contact").then(function(n){var o=lf.op.and(n.id.neq(t.id),n.email.eq(t.email));return e.executeQuery(n,o).then(function(e){return 0===e.length})})};i.update=function(n,i,c){"email"===i?!function(){var a=n.email;n[i]=c,Promise.resolve(r(n)).then(function(e){if(!e){n[i]=a;var o="Can't update the email field",r="Error";return t.showMessage(r,o).then(function(){}).then(function(){return Promise.reject(!1)})}}).then(function(t){e.update("Contact",n.id,n).then(function(){o.$apply()})},function(e){})}():(n[i]=c,e.update("Contact",n.id,n).then(function(){o.$apply()}))},i.favorite=function(e){i.update(e,"starred",!e.starred)},i.openCategoryMenu=function(t){e.list("Category").then(function(e){return t.categories.forEach(function(t,n){e.forEach(function(n,o){n.id==t.id&&e.splice(o,1)})}),Promise.resolve(e)}).then(function(e){i.categoriesMenu=e})},i.removeCategory=function(t,n){e.getSchema("ContactCategory").then(function(r){var c=lf.op.and(r.contact_id.eq(t.id),r.category_id.eq(n.id));e.executeQuery(r,c).then(function(r){e.del("ContactCategory",r[0].id).then(function(){t.categories.splice(t.categories.indexOf(n),1),i.categoriesMenu.push(n),o.$apply()})})})},i.addCategory=function(t,n){e.list("ContactCategory").then(function(e){if(0==e.length)return Promise.resolve(n);if(0==t.categories.length)return Promise.resolve(n);var o=void 0;return t.categories.forEach(function(e,t){if(e.id!=n.id)return void(o=n)}),Promise.resolve(o)}).then(function(n){if(null!=n){var o={contact_id:t.id,category_id:n.id};e.add("ContactCategory",o).then(function(e){t.categories.push(n),i.categoriesMenu.splice(i.categoriesMenu.indexOf(n),1)})}}).then(function(){o.$apply()})},i.$onInit=function(){loadCategories()}}require(["app"],function(t){t.component("contact",{templateUrl:"/src/components/templates/contactTemplate.html",controller:e,controllerAs:"contact",bindings:{data:"="}})}),define(["app","services/dbService","services/dialogService","components/categoryComponent","components/editableFieldComponent"],function(){return e})}();